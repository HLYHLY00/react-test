const fetch = require("node-fetch");
const xlsx = require("node-xlsx");
const fs = require("fs");
async function sleep(time) {
  return new Promise((resolve) => {
    setTimeout(() => resolve(), time);
  });
}
const courseList = [];
async function fetchData() {
  try {
    const body = {
      category_id: "0",
      cursor: "0",
      sort: 10,
      limit: 20,
      coupon_id: "",
    };
    let hasMore = true;
    while (hasMore) {
      const response = await fetch("https://api.juejin.cn/booklet_api/v1/booklet/listbycategory?aid=2608&uuid=7236647689314666023&spider=0", 
      {
        headers: {
          accept: "*/*",
          "accept-language": "zh-CN,zh;q=0.9,zh-TW;q=0.8",
          "content-type": "application/json",
          "sec-ch-ua": "\"Not.A/Brand\";v=\"8\", \"Chromium\";v=\"114\", \"Google Chrome\";v=\"114\"",
          "sec-ch-ua-mobile": "?0",
          "sec-ch-ua-platform": "\"Windows\"",
          "sec-fetch-dest": "empty",
          "sec-fetch-mode": "cors",
          "sec-fetch-site": "same-site",
          "x-secsdk-csrf-token": 
            "000100000001d9144867698ca3728b9b635af0d73d48c4c41b6bb7862f37d04d5926aeb963e91768c2022678cf62",
          cookie: 
            "passport_csrf_token=379cd12f16fd7279abe594f3e28433a4; passport_csrf_token_default=379cd12f16fd7279abe594f3e28433a4; n_mh=SFW6Aw_CCW-XFkuF54aHzV3cYl4JG2NihHzdCkriWnI; passport_auth_status=0f162800748113b08e5f534e6b50b423%2C; passport_auth_status_ss=0f162800748113b08e5f534e6b50b423%2C; store-region=cn-sc; store-region-src=uid; __tea_cookie_tokens_2608=%257B%2522user_unique_id%2522%253A%25227236647689314666023%2522%252C%2522web_id%2522%253A%25227236647689314666023%2522%252C%2522timestamp%2522%253A1685359914707%257D; _tea_utm_cache_2608={%22utm_source%22:%22course_list%22}; _tea_utm_cache_2018={%22utm_source%22:%22course_list%22}; csrf_session_id=2d2c59e9772bcad6cf28bd6639e5cfa3; sid_guard=e872d2fdc0299deffd2b6f55c4125645%7C1686809114%7C21600%7CThu%2C+15-Jun-2023+12%3A05%3A14+GMT; uid_tt=8b98e7d390dbcce8506622889a38aaeb; uid_tt_ss=8b98e7d390dbcce8506622889a38aaeb; sid_tt=e872d2fdc0299deffd2b6f55c4125645; sessionid=e872d2fdc0299deffd2b6f55c4125645; sessionid_ss=e872d2fdc0299deffd2b6f55c4125645; sid_ucp_v1=1.0.0-KGVjMDg2MTQ4ZTI0ZDQ5MTk2MGE3NjdkYTYxMDQ3NDYzNjM5YjAzODUKCRCa1KqkBhiwFBoCbGYiIGU4NzJkMmZkYzAyOTlkZWZmZDJiNmY1NWM0MTI1NjQ1; ssid_ucp_v1=1.0.0-KGVjMDg2MTQ4ZTI0ZDQ5MTk2MGE3NjdkYTYxMDQ3NDYzNjM5YjAzODUKCRCa1KqkBhiwFBoCbGYiIGU4NzJkMmZkYzAyOTlkZWZmZDJiNmY1NWM0MTI1NjQ1; msToken=XLqPOq52H-FOl4Oa2TV0tPgeJ-bdXeC_B30ZZRA0_Qc4K2LLO92XQbNuY3A9LOvlyTiMFWDwjoe-UCplBsqt8bvqQBRqYtfikGKTraVfOiv_OqY7rZhYPU_33lpt4zO9",
          Referer: "https://juejin.cn/",
          "Referrer-Policy": "strict-origin-when-cross-origin"
        },
        body: JSON.stringify(body),
        method: "POST",
      }
    );
      console.log("cursor:", body.cursor);
      const res = await response.json();
      hasMore = res.has_more;
      body.cursor = res.cursor;
      for (let info of res.data) {
        // 背景图：base_info.cover_img
        // 课程号：base_info.booklet_id
        // 标题：base_info.title
        // 描述：base_info.summary
        // 数量：base_info.buy_count
        // 打折：event_discount.discount_rate
        // 原价：base_info.price
        // 上架时间：base_info.put_on_time
        // 返现红包：原价*20%
        const course = {
          cover_img: info.base_info.cover_img,
          booklet_id: info.base_info.booklet_id,
          title: info.base_info.title,
          summary: info.base_info.summary,
          buy_count: info.base_info.buy_count,
          price: info.base_info.price,
          put_on_time: info.base_info.put_on_time,
        };
        // 是否有打折
        if (info.event_discount && info.event_discount.discount_rate) {
          course.discount_rate = info.event_discount.discount_rate;
        } else {
          course.discount_rate = 10; // 没有打折就是 10
        }
        courseList.push(course);
      }
      await sleep(3000);
    }

    console.log("课程数:", courseList.length);
    const courseListData = courseList.map((item) => [
        item.cover_img,
        item.booklet_id,
        item.title,
        item.summary,
        item.buy_count,
        item.price,
        item.put_on_time,
        item.discount_rate,
      ]);
    console.log("开始写入文件:");
    const excel = [
      {
        name: "sheet1",
        data: courseListData,
      },
    ];
    const buffer = xlsx.build(excel);

    // 写入文件
    fs.writeFile("course.xlsx", buffer, function (err) {
      if (err) {
        console.log("Write failed: " + err);
        return;
      }

      console.log("Write completed.");
    });
  } catch (error) {
    console.log(error);
  }
}

fetchData();